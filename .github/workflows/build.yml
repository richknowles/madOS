name: Build madOS ISO

on:
  push:
    branches: [main, master, "claude/**"]
    paths-ignore:
      - "**.md"
      - "docs/**"
  schedule:
    - cron: "0 6 * * 0" # Weekly rebuild on Sunday 06:00 UTC
  workflow_dispatch:     # Manual trigger from GitHub Actions UI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-iso:
    name: Build ISO
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged   # Required for loop devices and ZFS module loading

    permissions:
      contents: write         # Needed to upload release assets
      packages: write

    steps:
      # ── Checkout ────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v6

      # ── Base system setup ───────────────────────────────────────────────────
      - name: Initialize pacman keyring and update system
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            archiso \
            git \
            curl \
            wget \
            squashfs-tools \
            erofs-utils \
            dosfstools \
            libisoburn

      # ── Add CachyOS repos ───────────────────────────────────────────────────
      - name: Add CachyOS repositories and keys
        run: |
          # Download and install CachyOS keyring + mirrorlist packages
          CACHY_MIRROR="https://mirror.cachyos.org/repo/x86_64/cachyos"
          PKGS=(
            "cachyos-keyring"
            "cachyos-mirrorlist"
            "cachyos-v3-mirrorlist"
          )

          for pkg in "${PKGS[@]}"; do
            # Find latest version of each package
            latest=$(curl -s "${CACHY_MIRROR}/" | grep -oP "${pkg}-[0-9.]+-[0-9]+-any\.pkg\.tar\.zst" | sort -V | tail -1)
            if [[ -n "$latest" ]]; then
              curl -O "${CACHY_MIRROR}/${latest}"
            fi
          done

          # Install packages bypassing signature check for bootstrap
          pacman -U --noconfirm --needed *.pkg.tar.zst || true

          # Populate CachyOS keys
          pacman-key --populate cachyos || true

          # Append CachyOS repos to pacman.conf
          # (printf avoids heredoc indentation issues inside YAML run blocks)
          printf '\n[cachyos]\nInclude = /etc/pacman.d/cachyos-mirrorlist\n\n[cachyos-v3]\nInclude = /etc/pacman.d/cachyos-v3-mirrorlist\n' \
            >> /etc/pacman.conf

          # Refresh package databases
          pacman -Sy --noconfirm || true

      # ── Prepare archiso profile ─────────────────────────────────────────────
      - name: Prepare build workspace
        run: |
          mkdir -p /tmp/work /tmp/out
          cp -r archiso /tmp/profile
          chmod +x /tmp/profile/airootfs/root/*.sh

      # ── Build ISO ───────────────────────────────────────────────────────────
      - name: Build ISO with mkarchiso
        run: |
          mkarchiso -v -w /tmp/work -o /tmp/out /tmp/profile
        env:
          SOURCE_DATE_EPOCH: ${{ github.event.repository.pushed_at || '0' }}

      # ── Checksum ────────────────────────────────────────────────────────────
      - name: Generate SHA256 checksum
        run: |
          cd /tmp/out
          sha256sum *.iso > SHA256SUMS
          cat SHA256SUMS

      # ── Upload artifact ─────────────────────────────────────────────────────
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: madOS-${{ github.sha }}
          path: |
            /tmp/out/*.iso
            /tmp/out/SHA256SUMS
          retention-days: 14
          compression-level: 0   # ISO is already compressed

      # ── Create GitHub Release on tagged pushes ──────────────────────────────
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            /tmp/out/*.iso
            /tmp/out/SHA256SUMS
          name: "madOS ${{ github.ref_name }}"
          body: |
            ## madOS ${{ github.ref_name }}

            Immutable CachyOS with ZFS boot environments and ML4W Hyprland.

            ### Installation
            1. Flash the ISO to a USB drive: `dd if=madOS-*.iso of=/dev/sdX bs=4M status=progress`
            2. Boot from USB — the installer launches automatically
            3. Follow the TUI prompts (disk, hostname, user, dotfiles URL)
            4. Reboot into ZFSBootMenu

            ### Rollback workflow
            ```bash
            # Before any update:
            sudo zfs snapshot zroot/ROOT/arch@pre-update-$(date +%Y%m%d)
            # Roll back: reboot → select snapshot in ZFSBootMenu
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
